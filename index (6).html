<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Midway Ford — VIN Recall & OASIS Helper</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1220">
<style>
  :root{
    --bg:#0b1220;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;
    --ok:#10b981;--warn:#f59e0b;--err:#ef4444;--accent:#3b82f6;--line:#273248;--pill:#1f2937
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(11,18,32,.9);backdrop-filter:blur(6px);
         border-bottom:1px solid var(--line);z-index:30}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  h1{display:flex;align-items:center;gap:10px;font-size:18px;margin:0}
  .brand{font-weight:800;letter-spacing:.3px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  main{padding:14px 14px 120px}
  button{background:var(--pill);color:var(--ink);border:1px solid var(--line);
    border-radius:14px;padding:12px 14px;font-weight:700;cursor:pointer;font-size:15px}
  button:active{transform:translateY(1px)}
  .hint{color:var(--muted);font-size:12px}
  video{width:100%;max-width:980px;border-radius:16px;border:1px solid var(--line);background:#000}
  .reticle{position:relative;margin-top:8px}
  .reticle:after{content:'';position:absolute;inset:12px;border:2px dashed rgba(96,165,250,.35);border-radius:12px;pointer-events:none}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin-top:12px}
  .list{display:grid;gap:10px}
  .vin{font-family:ui-monospace,Menlo,Consolas,monospace;letter-spacing:.5px;font-size:16px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:12px}
  .ok{background:rgba(16,185,129,.18);border-color:#134e4a;color:#10b981}
  .bad{background:rgba(239,68,68,.22);border-color:#7f1d1d;color:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,.12) inset}
  .unk{background:rgba(59,130,246,.16);border-color:#1e3a8a;color:#60a5fa}
  .checking{background:rgba(156,163,175,.18);border-color:#374151;color:#d1d5db}
  .tag{color:var(--muted);font-size:12px}
  .small{font-size:12px}
  .recall{border-left:3px solid var(--err);padding-left:8px;margin-top:6px}
  a{color:var(--accent);text-decoration:none}
  input{width:100%;background:#0b1220;color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:16px}
  .scanbar{position:fixed;left:0;right:0;bottom:0;background:rgba(10,14,24,.92);
    border-top:1px solid var(--line);padding:10px 14px;z-index:40}
  .scanmsg{display:flex;align-items:center;gap:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;background:#0b1220;border:1px solid var(--line);
    padding:14px 16px;border-radius:12px;z-index:50;opacity:0;transition:opacity .2s, transform .2s}
  .toast.show{opacity:1;transform:translate(-50%,-4px)}
  .banner{position:fixed;inset:auto 0 120px 0;display:none;justify-content:center;z-index:45}
  .banner > div{padding:10px 16px;border-radius:12px;border:1px solid var(--line);font-weight:800}
  .banner.yes{display:flex} .banner.yes > div{background:rgba(239,68,68,.2);color:#ef4444}
  .banner.no{display:flex}  .banner.no  > div{background:rgba(16,185,129,.18);color:#10b981}
  .spinner{width:14px;height:14px;border:2px solid #9ca3af;border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin 1s linear infinite;margin-left:6px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .countChip{padding:4px 8px;border-radius:999px;background:#1f2937;border:1px solid #273248;font-size:12px}
  .grid2{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:760px){.grid2{grid-template-columns:1fr 1fr}}
  .settings{display:flex;gap:12px;flex-wrap:wrap}
  .settings label{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#d1d5db}
  .ghost{opacity:.7}
</style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <h1><span class="brand">Midway Ford</span> — VIN Recall & OASIS Helper</h1>
      <div class="row">
        <button id="installBtn" hidden>Add to Home</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <button id="start">Start Camera</button>
        <button id="stop">Stop</button>
        <button id="export">Export CSV</button>
        <button id="batch">Batch OASIS</button>
        <button id="importPDF">Import OASIS PDF(s)</button>
        <button id="clear">Clear</button>
        <span class="right tag">Aim at the <b>door‑jamb PDF417</b> label. Good light = best accuracy.</span>
      </div>

      <div class="settings" style="margin-top:8px">
        <label><input id="fordOnly" type="checkbox" checked> Ford/Lincoln only</label>
        <label><input id="strictFrames" type="checkbox" checked> Stricter capture (≥3/5 frames)</label>
        <label><input id="soundOn" type="checkbox" checked> Sound</label>
        <label><input id="hapticsOn" type="checkbox" checked> Haptics</label>
        <span class="countChip">Open: <span id="openCount">0</span></span>
      </div>

      <div class="grid2">
        <div class="reticle"><video id="preview" playsinline muted></video></div>
        <div>
          <input id="manual" placeholder="Type/Paste VIN and press Enter">
          <div class="hint" style="margin-top:6px">
            Auto-checks NHTSA by VIN. For FSAs/CSPs, use OASIS links or Batch OASIS.
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Scanned VINs</strong>
        <span class="tag"><span id="count">0</span> total</span>
      </div>
      <div id="list" class="list"></div>
    </section>
  </main>

  <div class="banner" id="banner"><div id="bannerText"></div></div>
  <div class="scanbar"><div id="scanmsg" class="scanmsg"><span class="tag">Scanner idle.</span></div></div>
  <div id="toast" class="toast">Scanned</div>

  <!-- Batch modal -->
  <div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60">
    <div style="background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;max-width:760px;width:92%">
      <div class="row" style="justify-content:space-between"><strong>Batch OASIS</strong><button id="closeModal">Close</button></div>
      <p class="small">Copy or download these VINs to paste/upload into <b>FordTechService ▸ Quick Links ▸ Batch OASIS</b>. We can’t auto‑submit from GitHub Pages (Ford login + CORS), but this prepares the list instantly.</p>
      <div class="row"><button id="copyAll">Copy ALL VINs</button><button id="copyOpen">Copy ONLY Open (NHTSA YES)</button><button id="downloadBatch">Download batch_oasis.csv</button><a class="pill" target="_blank" href="https://www.fordtechservice.dealerconnection.com/">Open FordTechService</a></div>
      <p class="small tag">Preview (editable):</p>
      <textarea id="batchText" style="width:100%;height:180px;background:#0b1220;color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:10px 12px"></textarea>
    </div>
  </div>

  <!-- ZXing + fallback BarcodeDetector -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <!-- PDF.js for on-device OASIS PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>

  <script>
    // ====== PWA install + SW ======
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
    let deferredPrompt; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.hidden=false;});
    installBtn?.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.hidden=true;});

    // ====== VIN helpers (ISO 3779) ======
    const translit={'A':1,'B':2,'C':3,'D':4,'E':5,'F':6,'G':7,'H':8,'J':1,'K':2,'L':3,'M':4,'N':5,'P':7,'R':9,'S':2,'T':3,'U':4,'V':5,'W':6,'X':7,'Y':8,'Z':9,'0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9};
    const weights=[8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
    function checkDigit(vin){ let sum=0; for(let i=0;i<17;i++){ const c=vin[i]; const v=translit[c]; if(v===undefined) return null; sum += v*weights[i]; } const r=sum%11; return r===10?'X':String(r); }
    function isValidVIN(v){ if(!v||v.length!==17) return false; if(/[IOQ]/.test(v)) return false; return checkDigit(v)===v[8]; }
    function normVIN(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,17); }
    const fordWMIs = ['1FA','1FB','1FC','1FD','1FM','1FT','1ZV','2FM','3FA','3FD','3LN','5LM','5LME','5LMR'];
    function looksFord(v){ return fordWMIs.some(w=>v.startsWith(w)); }

    // ====== State ======
    const listEl=document.getElementById('list'), countEl=document.getElementById('count'), openCountEl=document.getElementById('openCount');
    const fordOnly=document.getElementById('fordOnly'), strictFrames=document.getElementById('strictFrames');
    const soundOn=document.getElementById('soundOn'), hapticsOn=document.getElementById('hapticsOn');
    const vins=new Map(); function load(){try{JSON.parse(localStorage.getItem('vins')||'[]').forEach(v=>vins.set(v.vin,v));}catch{} } function save(){localStorage.setItem('vins',JSON.stringify([...vins.values()]));} load();

    function recalcOpenCount(){ let n=0; for(const v of vins.values()){ if(v.status==='OPEN') n++; } openCountEl.textContent=n; }
    function render(){
      listEl.innerHTML='';
      const arr=[...vins.values()].sort((a,b)=>{
        const ao=a.status==='OPEN'?0:1, bo=b.status==='OPEN'?0:1; if(ao!==bo) return ao-bo;
        return (b.ts||0)-(a.ts||0);
      });
      countEl.textContent=String(arr.length); recalcOpenCount();
      for(const v of arr){
        const cls=v.status==='OPEN'?'bad':v.status==='NONE'?'ok':v.status==='CHECKING'?'checking':'unk';
        const label=v.status==='OPEN'?'Recall: YES':v.status==='NONE'?'Recall: NO':v.status==='CHECKING'?'Checking…':'Unknown';
        const recs=(v.campaigns||[]).map(c=>`<div class="small recall">• ${c}</div>`).join('');
        const ymm=[v.year,v.make,v.model].filter(Boolean).join(' ');
        const verifyURL=`https://www.nhtsa.gov/recalls?vin=${encodeURIComponent(v.vin)}`;
        const oasisURL=`https://www.fordtechservice.dealerconnection.com/oasis/Index?vin=${encodeURIComponent(v.vin)}`;
        const row=document.createElement('div'); row.className='card';
        row.innerHTML=`
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div class="vin">${v.vin}</div>
              <div class="tag">${ymm||'—'}</div>
              <div class="small">${new Date(v.ts).toLocaleTimeString()} ${v.detail?`• <span class="tag">${v.detail}</span>`:''}</div>
            </div>
            <div class="row right">
              <span class="pill ${cls}">${label}${v.status==='CHECKING'?'<span class="spinner"></span>':''}</span>
              <a class="pill" target="_blank" href="${verifyURL}">NHTSA</a>
              <a class="pill" target="_blank" href="${oasisURL}">OASIS</a>
              <button class="pill" data-del="${v.vin}">Remove</button>
            </div>
          </div>
          <div>${recs || '<div class="small tag">No campaign details yet.</div>'}</div>`;
        listEl.appendChild(row);
      }
    }
    render();
    listEl.addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; if(b.dataset.del){ vins.delete(b.dataset.del); save(); render(); }});

    // ====== Feedback ======
    const scanmsg=document.getElementById('scanmsg'), toast=document.getElementById('toast'), banner=document.getElementById('banner'), bannerText=document.getElementById('bannerText');
    function setScanMsg(html){ scanmsg.innerHTML=html; }
    function showToast(text){ toast.textContent=text; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1000); }
    function flashBanner(type,text){ banner.className='banner '+type; bannerText.textContent=text; setTimeout(()=>{banner.className='banner';}, 1000); }
    let beep=null; try{ beep=new Audio("data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICAgP//"); }catch{}

    // ====== NHTSA lookups (robust) ======
    async function decodeYMM(v){
      try{ const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${encodeURIComponent(v)}?format=json`);
        const j=await r.json(); const row=j?.Results?.[0]||{}; return {year:row.ModelYear||'', make:row.Make||'', model:row.Model||''}; }catch{return {};}
    }
    async function recallsByVin(v){
      try{ const r=await fetch(`https://api.nhtsa.gov/recalls/recallsByVin?vin=${encodeURIComponent(v)}`);
        if(!r.ok) throw 0; const j=await r.json(); const items=j?.results||j?.Results||[];
        return items.map(x=>x.NHTSACampaignNumber||x.campaignNumber).filter(Boolean);
      }catch(e){ return null; }
    }
    async function recallsByVehicle(make,model,year){
      try{ const r=await fetch(`https://api.nhtsa.gov/recalls/recallsByVehicle?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&modelYear=${encodeURIComponent(year)}`);
        if(!r.ok) throw 0; const j=await r.json(); const items=j?.results||j?.Results||[];
        return items.slice(0,6).map(x=>`${x.NHTSACampaignNumber||x.campaignNumber||''} – ${x.Component||x.ComponentDescription||''}`);
      }catch(e){ return []; }
    }
    async function autoCheck(vin, rec){
      rec.status='CHECKING'; rec.campaigns=[]; rec.detail=''; save(); render();
      const ymm=await decodeYMM(vin); Object.assign(rec, ymm); save(); render();
      let vinCampaigns=null, tries=0; while(tries<3 && vinCampaigns===null){ vinCampaigns = await recallsByVin(vin); if(vinCampaigns===null){ tries++; await new Promise(r=>setTimeout(r, 450*tries)); } }
      if(Array.isArray(vinCampaigns)){
        if(vinCampaigns.length>0){ rec.status='OPEN'; rec.campaigns=vinCampaigns; rec.detail='NHTSA VIN: open recall(s)'; flashBanner('yes','OPEN RECALL'); }
        else { rec.status='NONE'; rec.detail='NHTSA VIN: none found'; flashBanner('no','NO OPEN RECALLS'); }
      } else {
        const poss = await recallsByVehicle(rec.make||'', rec.model||'', rec.year||'');
        rec.status='UNKNOWN'; rec.campaigns=poss; rec.detail='Could not confirm by VIN (browser/API)';
      }
      save(); render();
    }

    // ====== Accept VIN (accuracy gating) ======
    const recent=[]; const counts=new Map(); let acceptCooldown=0;
    function pushCandidate(vin, windowSize){
      recent.push(vin); if(recent.length>10) recent.shift();
      counts.clear();
      for(let i=Math.max(0,recent.length-windowSize); i<recent.length; i++){ const k=recent[i]; counts.set(k,(counts.get(k)||0)+1); }
      let best={vin:null,hits:0}; counts.forEach((h,k)=>{ if(h>best.hits) best={vin:k,hits:h}; });
      return best;
    }
    async function considerCandidate(raw){
      const cand=normVIN(raw);
      if(cand.length<17){ setScanMsg(`Reading… <span class="tag">${cand}</span>`); return; }
      if(/[IOQ]/.test(cand)){ setScanMsg(`Rejected (I/O/Q): <span class="ghost">${cand}</span>`); return; }
      if(!isValidVIN(cand)){ setScanMsg(`Rejected (checksum): <span class="ghost">${cand}</span>`); return; }
      if(fordOnly.checked && !looksFord(cand)){ setScanMsg(`Rejected (non‑Ford WMI): <span class="ghost">${cand}</span>`); return; }

      const windowSize = strictFrames.checked ? 5 : 4;
      const needHits   = strictFrames.checked ? 3 : 2;
      const best=pushCandidate(cand, windowSize);
      setScanMsg(`Confirming… ${best.vin} <span class="tag">(${best.hits}/${needHits})</span>`);
      if(best.vin===cand && best.hits>=needHits && (Date.now()-acceptCooldown)>500){
        acceptCooldown=Date.now(); await acceptVIN(cand);
      }
    }
    async function acceptVIN(vin){
      if(soundOn.checked && beep){ try{ beep.currentTime=0; beep.play(); }catch{} }
      if(hapticsOn.checked){ try{ navigator.vibrate && navigator.vibrate([40,30,40]); }catch{} }
      showToast('VIN accepted ✅'); setScanMsg(`Accepted: <b>${vin}</b>`);
      if(!vins.has(vin)) vins.set(vin,{vin});
      const rec=vins.get(vin); rec.ts=Date.now(); save(); render();
      await autoCheck(vin,rec);
    }

    // ====== Manual entry ======
    document.getElementById('manual').addEventListener('keydown',e=>{
      if(e.key==='Enter'){ const v=normVIN(e.target.value); e.target.value=''; if(isValidVIN(v)){ acceptVIN(v); } else { showToast('Invalid VIN (checksum)'); } }
    });

    // ====== Camera (ZXing with fallback) ======
    const startBtn=document.getElementById('start'), stopBtn=document.getElementById('stop'), video=document.getElementById('preview');
    let codeReader, controls, running=false;
    async function startZXing(){
      const ZXB=window.ZXingBrowser, ZX=window.ZXing;
      if(!ZXB||!ZX) throw new Error('ZXing not ready');
      codeReader=new ZXB.BrowserMultiFormatReader();
      const devices=await ZXB.BrowserCodeReader.listVideoInputDevices();
      const back=devices.find(d=>/back|rear|environment/i.test(d.label))?.deviceId;
      controls=await codeReader.decodeFromVideoDevice(back||undefined, video, (res)=>{
        if(res){ const text=res.getText(); const candidate=(text.match(/[A-HJ-NPR-Z0-9]{17}/g)||[])[0]||text; considerCandidate(candidate); }
      }, {videoConstraints:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}}});
      running=true; setScanMsg('Camera started. Reading…');
    }
    async function startNative(){
      const detector = new BarcodeDetector({formats:['pdf417','code_39','code_128']});
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}}});
      video.srcObject=stream; await video.play(); running=true;
      (async function loop(){
        while(running){
          try{ const codes=await detector.detect(video);
            for(const c of codes){ const candidate=normVIN(c.rawValue||c.displayValue||''); if(candidate){ await considerCandidate(candidate); } }
          }catch{}
          await new Promise(r=>setTimeout(r,110));
        }
      })();
      setScanMsg('Camera started. Reading…');
    }
    async function startCamera(){
      try{ await startZXing(); }catch(e1){ try{ await startNative(); }catch(e2){ alert('Camera start failed. Use Chrome/Edge and allow camera.\\n'+(e1?.message||'')+'\\n'+(e2?.message||'')); } }
    }
    function stopCamera(){ try{running=false; controls&&controls.stop(); codeReader&&codeReader.reset();}catch{} video.srcObject=null; setScanMsg('Scanner stopped.'); }
    startBtn.addEventListener('click',startCamera);
    stopBtn.addEventListener('click',stopCamera);

    // ====== Export / Clear ======
    document.getElementById('export').addEventListener('click',()=>{
      const rows=[['VIN','Year','Make','Model','Status','Details','Campaigns']];
      for(const v of vins.values()){ rows.push([v.vin,v.year||'',v.make||'',v.model||'',v.status||'',v.detail||'',(v.campaigns||[]).join(' | ')]); }
      const blob=new Blob([rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n')],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='midway_recall_scan.csv'; a.click();
    });
    document.getElementById('clear').addEventListener('click',()=>{ if(confirm('Clear scanned list?')){ localStorage.removeItem('vins'); vins.clear(); render(); setScanMsg('List cleared.'); }});

    // ====== Batch OASIS ======
    const modal=document.getElementById('modal'), openBatch=document.getElementById('batch'), closeModal=document.getElementById('closeModal'), batchText=document.getElementById('batchText');
    openBatch.addEventListener('click',()=>{ const lines=[...vins.values()].map(v=>v.vin).join('\n'); batchText.value=lines; modal.style.display='flex'; });
    closeModal.addEventListener('click',()=>modal.style.display='none');
    document.getElementById('copyAll').addEventListener('click',async()=>{ await navigator.clipboard.writeText(batchText.value); showToast('All VINs copied'); });
    document.getElementById('copyOpen').addEventListener('click',async()=>{
      const openVINs=[...vins.values()].filter(v=>v.status==='OPEN').map(v=>v.vin).join('\n');
      await navigator.clipboard.writeText(openVINs); showToast('Open-ONLY VINs copied');
    });
    document.getElementById('downloadBatch').addEventListener('click',()=>{
      const rows=[['VIN']]; for(const v of vins.values()) rows.push([v.vin]);
      const blob=new Blob([rows.map(r=>r.join(',')).join('\n')], {type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='batch_oasis.csv'; a.click();
    });

    // ====== OASIS PDF Import (on-device) ======
    document.getElementById('importPDF').addEventListener('click', async()=>{
      try{
        const [fh] = await window.showOpenFilePicker({multiple:true,types:[{description:'PDFs',accept:{'application/pdf':['.pdf']}}]}).catch(()=>[null]);
        if(!fh) return;
        const file = await fh.getFile();
        await parseOasisPdf(file);
      }catch{
        const input=document.createElement('input'); input.type='file'; input.accept='application/pdf'; input.multiple=true;
        input.onchange=async(e)=>{ for(const f of e.target.files) await parseOasisPdf(f); };
        input.click();
      }
    });
    async function parseOasisPdf(file){
      try{
        const data=new Uint8Array(await file.arrayBuffer());
        const pdf=await pdfjsLib.getDocument({data}).promise;
        let fullText='';
        for(let i=1;i<=pdf.numPages;i++){ const page=await pdf.getPage(i); const txt=await page.getTextContent(); fullText += ' '+txt.items.map(t=>t.str).join(' '); }
        fullText = fullText.replace(/\s+/g,' ').toUpperCase();
        const vinMatches = fullText.match(/[A-HJ-NPR-Z0-9]{17}/g) || [];
        const foundVINs = Array.from(new Set(vinMatches.filter(v=>isValidVIN(v))));
        const campMatches = fullText.match(/\b(2[0-9][A-Z][0-9]{2,})\b/g) || [];
        const campSet = Array.from(new Set(campMatches));
        if(foundVINs.length===0 && campSet.length>0){
          const arr=[...vins.values()].sort((a,b)=>(b.ts||0)-(a.ts||0));
          if(arr[0]){ const rec=arr[0]; rec.status='OPEN'; rec.campaigns=Array.from(new Set([...(rec.campaigns||[]),...campSet])); save(); render(); flashBanner('yes','OASIS: OPEN FSA'); }
        }else{
          for(const v of foundVINs){
            if(!vins.has(v)) vins.set(v,{vin:v, ts:Date.now()});
            const rec=vins.get(v); rec.status='OPEN'; rec.campaigns=Array.from(new Set([...(rec.campaigns||[]),...campSet])); save(); render();
          }
          flashBanner('yes','OASIS: OPEN FSA');
        }
        showToast('Imported '+file.name);
      }catch(err){ alert('Could not parse OASIS PDF: '+(err?.message||err)); }
    }
  </script>
</body>
</html>
