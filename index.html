<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Midway Ford — VIN Recall (Safe Mode + OASIS)</title>
<meta name="theme-color" content="#0b1220"/>
<style>
  :root{--bg:#0b1220;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--ok:#10b981;--err:#ef4444;--accent:#3b82f6;--line:#273248;--pill:#1f2937}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(11,18,32,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);z-index:20}
  .wrap{max-width:900px;margin:0 auto;padding:14px}
  h1{margin:0;font-size:18px;font-weight:800}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  button{background:var(--pill);color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  a.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:#1f2937;border:1px solid var(--line);color:var(--ink);text-decoration:none;font-size:12px}
  video{width:100%;max-width:900px;border-radius:12px;border:1px solid var(--line);background:#000}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px}
  .vin{font-family:ui-monospace,Menlo,Consolas,monospace;letter-spacing:.5px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1f2937;border:1px solid var(--line);font-size:12px}
  .ok{background:rgba(16,185,129,.18);border-color:#134e4a;color:#10b981}
  .bad{background:rgba(239,68,68,.22);border-color:#7f1d1d;color:#ef4444}
  .unk{background:rgba(59,130,246,.16);border-color:#1e3a8a;color:#60a5fa}
  .checking{background:rgba(156,163,175,.18);border-color:#374151;color:#d1d5db}
  .hint{color:var(--muted);font-size:12px}
  input{width:100%;background:#0b1220;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:16px}
  .status{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:#0b1220;border-top:1px solid var(--line);font-family:ui-monospace,Menlo,Consolas,monospace}
  .errtxt{color:var(--err)}
</style>
</head>
<body>
<header><div class="wrap"><h1>Midway Ford — VIN Recall (Safe Mode + OASIS)</h1></div></header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <button id="start">Start Camera</button>
      <button id="stop">Stop</button>
      <button id="export">Export CSV</button>
      <button id="clear">Clear</button>
      <span class="right hint">PDF417 door-jamb label scans best.</span>
    </div>
    <video id="preview" playsinline muted></video>
    <div style="margin-top:8px"><input id="manual" placeholder="Type/Paste VIN (17 chars) and press Enter"></div>
    <div class="hint" id="compat"></div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between">
      <strong>Scanned VINs</strong>
      <span class="hint"><span id="count">0</span> total</span>
    </div>
    <div id="list"></div>
  </section>
</main>

<div class="status" id="status">Ready.</div>

<!-- ZXing (fallback) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
  // ---- VIN helpers (ISO 3779 check) ----
  function normVIN(s){return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,17);}
  const translit={'A':1,'B':2,'C':3,'D':4,'E':5,'F':6,'G':7,'H':8,'J':1,'K':2,'L':3,'M':4,'N':5,'P':7,'R':9,'S':2,'T':3,'U':4,'V':5,'W':6,'X':7,'Y':8,'Z':9,'0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9};
  const weights=[8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
  function checkDigit(v){let s=0;for(let i=0;i<17;i++){const c=v[i];const val=translit[c];if(val===undefined) return null;s+=val*weights[i];}const r=s%11;return r===10?'X':String(r);}
  function isValidVIN(v){return v&&v.length===17&&!/[IOQ]/.test(v)&&checkDigit(v)===v[8];}

  const statusEl=document.getElementById('status');
  function setStatus(msg, isErr=false){statusEl.textContent=msg; statusEl.className='status'+(isErr?' errtxt':'');}

  // ---- State & render ----
  const listEl=document.getElementById('list'), countEl=document.getElementById('count');
  const vins=new Map();
  function load(){try{JSON.parse(localStorage.getItem('vins')||'[]').forEach(v=>vins.set(v.vin,v));}catch{}}
  function save(){localStorage.setItem('vins',JSON.stringify([...vins.values()]));}
  function pillClass(v){return v.status==='OPEN'?'bad':v.status==='NONE'?'ok':v.status==='CHECKING'?'checking':'unk';}
  function pillText(v){return v.status==='OPEN'?'Recall: YES':v.status==='NONE'?'Recall: NO':v.status==='CHECKING'?'Checking…':'Unknown';}
  function render(){
    listEl.innerHTML='';
    const arr=[...vins.values()].sort((a,b)=>(b.ts||0)-(a.ts||0));
    countEl.textContent=String(arr.length);
    for(const v of arr){
      const campaigns=(v.campaigns||[]).join(' | ');
      const nhtsaLink=`https://www.nhtsa.gov/recalls?vin=${encodeURIComponent(v.vin)}`;
      const oasisLink=`https://www.fordtechservice.dealerconnection.com/oasis/Index?vin=${encodeURIComponent(v.vin)}`;
      const row=document.createElement('div'); row.className='card';
      row.innerHTML=`
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="vin">${v.vin}</div>
            <div class="hint">${v.year||''} ${v.make||''} ${v.model||''}</div>
            <div class="hint">${campaigns||''}</div>
          </div>
          <div class="row right">
            <span class="pill ${pillClass(v)}">${pillText(v)}</span>
            <a class="btn" target="_blank" href="${nhtsaLink}">Verify (NHTSA)</a>
            <a class="btn" target="_blank" href="${oasisLink}">Open OASIS</a>
            <button class="btn" data-retry="${v.vin}">Retry NHTSA</button>
            <button class="btn" data-del="${v.vin}">Remove</button>
          </div>
        </div>`;
      listEl.appendChild(row);
    }
  }
  load(); render();

  listEl.addEventListener('click',async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.del){vins.delete(b.dataset.del); save(); render(); return;}
    if(b.dataset.retry){ const vin=b.dataset.retry; if(vins.has(vin)){ await runNHTSA(vin, vins.get(vin), true); } }
  });

  async function decodeYMM(v){
    try{
      const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${encodeURIComponent(v)}?format=json`);
      const j=await r.json(); const row=j?.Results?.[0]||{}; return {year:row.ModelYear||'', make:row.Make||'', model:row.Model||''};
    }catch{return {};}
  }

  // NHTSA with 3 retries + timeout
  async function fetchWithTimeout(url, ms){
    const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(), ms);
    try{ const res=await fetch(url,{signal:ctrl.signal}); return res; } finally { clearTimeout(id); }
  }
  async function runNHTSA(vin, rec, manualRetry=false){
    rec.status='CHECKING'; rec.campaigns=[]; save(); render();
    const url=`https://api.nhtsa.gov/recalls/recallsByVin?vin=${encodeURIComponent(vin)}`;
    let ok=false, items=[];
    for(let i=1;i<=3 && !ok;i++){
      try{
        const r=await fetchWithTimeout(url, 3500);
        if(!r.ok) throw 0;
        const j=await r.json();
        items=j?.results||j?.Results||[];
        ok=true;
      }catch(e){
        await new Promise(r=>setTimeout(r, i*300));
      }
    }
    if(ok){
      if(items.length){
        rec.status='OPEN';
        rec.campaigns = items.map(x=>x.NHTSACampaignNumber||x.campaignNumber).filter(Boolean);
        setStatus(`NHTSA: OPEN for ${vin}`);
      }else{
        rec.status='NONE';
        rec.campaigns=[];
        setStatus(`NHTSA: none for ${vin}`);
      }
    }else{
      rec.status='UNKNOWN';
      setStatus(`NHTSA: unavailable${manualRetry?' (after retry)':''}. Use OASIS.`, true);
    }
    save(); render();
  }

  async function addVIN(v){
    v=normVIN(v);
    if(v.length!==17){setStatus('VIN must be 17 characters.', true); return;}
    if(!isValidVIN(v)){setStatus('Invalid VIN (checksum). Please rescan.', true); return;}
    if(!vins.has(v)) vins.set(v,{vin:v});
    const rec=vins.get(v); rec.ts=Date.now(); save();

    // decode + NHTSA
    Object.assign(rec, await decodeYMM(v)); save(); render();
    await runNHTSA(v, rec);
  }

  // Manual entry
  document.getElementById('manual').addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){ const v=normVIN(e.target.value); e.target.value=''; addVIN(v); }
  });

  // Camera: try BarcodeDetector first, then ZXing
  const compat=document.getElementById('compat');
  const video=document.getElementById('preview');
  let stopFn=null;

  async function startCamera(){
    try{
      setStatus('Starting camera…');
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720}}, audio:false});
      video.srcObject=stream; await video.play();

      if('BarcodeDetector' in window){
        const Supported = await window.BarcodeDetector.getSupportedFormats().catch(()=>[]);
        compat.textContent = 'Using native barcode detector.';
        const fmts = ['pdf417','code_128','code_39','qr_code'].filter(f=>Supported.includes(f));
        const bd=new BarcodeDetector({formats: fmts});
        let rafId;
        const tick = async () => {
          try{
            const barcodes = await bd.detect(video);
            if(barcodes.length){
              const text = (barcodes[0].rawValue||'').toUpperCase();
              const candidate=(text.match(/[A-HJ-NPR-Z0-9]{17}/g)||[])[0]||text;
              if(candidate && candidate.length>=11){ await addVIN(candidate); }
            }
          }catch{}
          rafId = requestAnimationFrame(tick);
        };
        rafId = requestAnimationFrame(tick);
        stopFn = ()=>{ cancelAnimationFrame(rafId); stream.getTracks().forEach(t=>t.stop()); video.srcObject=null; setStatus('Scanner stopped.'); };
      } else {
        compat.textContent = 'Using ZXing fallback.';
        const ZXB=window.ZXingBrowser, ZX=window.ZXing;
        const reader=new ZXB.BrowserMultiFormatReader();
        const controls = await reader.decodeFromVideoDevice(null, video, (res)=>{
          if(res){
            const text=res.getText();
            const candidate=(text.match(/[A-HJ-NPR-Z0-9]{17}/g)||[])[0]||text;
            if(candidate) addVIN(candidate);
          }
        }, {videoConstraints:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}});
        stopFn = ()=>{controls&&controls.stop(); reader.reset(); stream.getTracks().forEach(t=>t.stop()); video.srcObject=null; setStatus('Scanner stopped.');};
      }
      setStatus('Camera ready. Aim at VIN (PDF417 preferred).');
    }catch(e){
      console.error(e);
      setStatus('Camera failed. Check permissions (Chrome/Edge over HTTPS).', true);
    }
  }

  function stopCamera(){ try{ stopFn && stopFn(); }catch{} }

  document.getElementById('start').addEventListener('click', startCamera);
  document.getElementById('stop').addEventListener('click', stopCamera);

  // Export & Clear
  document.getElementById('export').addEventListener('click',()=>{
    const rows=[['VIN','Year','Make','Model','Status','Campaigns']];
    for(const v of vins.values()){ rows.push([v.vin,v.year||'',v.make||'',v.model||'',v.status||'',(v.campaigns||[]).join(' | ')]); }
    const blob=new Blob([rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n')],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='midway_recall_scan.csv'; a.click();
  });
  document.getElementById('clear').addEventListener('click',()=>{ if(confirm('Clear all?')){ localStorage.removeItem('vins'); vins.clear(); render(); setStatus('Cleared.'); } });

  // Compatibility hints
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    document.getElementById('compat').innerHTML = '<span class="errtxt">Camera API not supported. Use Chrome/Edge on Android or iOS 15+ Safari.</span>';
  }
</script>
</body>
</html>
