<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Midway Ford – Recall VIN Checker</title>
<link rel="manifest" href='data:application/json,{"name":"Midway Ford Recall VIN Checker","short_name":"Recall Checker","start_url":".","display":"standalone","background_color":"#0b1220","theme_color":"#0b1220"}'>
<style>
  :root{
    --bg:#0b1220;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--accent:#3b82f6;--line:#273248;
    --pill:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);z-index:20}
  .wrap{max-width:920px;margin:0 auto;padding:14px}
  h1{display:flex;align-items:center;gap:10px;font-size:18px;margin:0}
  .brand{font-weight:800;letter-spacing:.4px}
  main{padding:14px;padding-bottom:96px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  button{background:var(--pill);color:var(--ink);border:1px solid var(--line);border-radius:14px;padding:14px 16px;font-weight:700;cursor:pointer;font-size:16px}
  button:active{transform:translateY(1px)}
  .hint{color:var(--muted);font-size:12px}
  video{width:100%;max-width:920px;border-radius:16px;border:1px solid var(--line);background:#000}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin-top:12px}
  .list{display:grid;gap:10px}
  .vin{font-family:ui-monospace,Menlo,Consolas,monospace;letter-spacing:.5px;font-size:16px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:12px}
  .ok{background:rgba(16,185,129,.18);border-color:#134e4a;color:#10b981}
  .bad{background:rgba(239,68,68,.2);border-color:#7f1d1d;color:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,.12) inset}
  .unk{background:rgba(59,130,246,.14);border-color:#1e3a8a;color:#60a5fa}
  .tag{color:var(--muted);font-size:12px}
  .small{font-size:12px}
  .recall{border-left:3px solid var(--err);padding-left:8px;margin-top:6px}
  a{color:var(--accent);text-decoration:none}
  input{width:100%;background:#0b1220;color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:16px}
  .scanbar{position:fixed;left:0;right:0;bottom:0;background:rgba(10,14,24,.92);border-top:1px solid var(--line);padding:10px 14px;z-index:30}
  .scanmsg{display:flex;align-items:center;gap:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .scanok{color:var(--ok)} .scanwarn{color:var(--warn)} .scanerr{color:var(--err)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:80px;background:#0b1220;border:1px solid var(--line);padding:14px 16px;border-radius:12px;z-index:40;opacity:0;transition:opacity .2s, transform .2s}
  .toast.show{opacity:1;transform:translate(-50%,-4px)}
  .reticle{position:relative;margin-top:8px}
  .reticle:after{content:'';position:absolute;inset:12px;border:2px dashed rgba(96,165,250,.3);border-radius:12px;pointer-events:none}
</style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <h1><span class="brand">Midway Ford</span> – Recall VIN Checker</h1>
      <div class="row">
        <button id="installBtn" hidden>Add to Home</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <button id="start">Start Camera</button>
        <button id="stop">Stop</button>
        <button id="export">Export CSV</button>
        <button id="clear">Clear List</button>
        <span class="right tag">Aim at the <b>door‑jamb PDF417</b> label. Good light = best accuracy.</span>
      </div>
      <div class="reticle">
        <video id="preview" playsinline muted></video>
      </div>
      <div class="row" style="margin-top:8px"><input id="manual" placeholder="Type/Paste VIN and press Enter"></div>
      <div class="hint" style="margin-top:6px">After each accepted scan, we validate with VIN checksum and require stability across frames to eliminate misreads. If VIN API is blocked, tap <b>Verify</b> for the official page. For Ford CSP/FSA/SSM items, use OASIS.</div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Scanned VINs</strong>
        <span class="tag"><span id="count">0</span> total</span>
      </div>
      <div id="list" class="list"></div>
    </section>
  </main>

  <div class="scanbar">
    <div id="scanmsg" class="scanmsg"><span class="tag">Scanner idle.</span></div>
  </div>
  <div id="toast" class="toast">Scanned</div>

  <!-- ZXing robust PDF417 + 1D -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <script>
    // --- Utility: VIN checksum validation (ISO 3779) ---
    const translit = {'A':1,'B':2,'C':3,'D':4,'E':5,'F':6,'G':7,'H':8,'J':1,'K':2,'L':3,'M':4,'N':5,'P':7,'R':9,'S':2,'T':3,'U':4,'V':5,'W':6,'X':7,'Y':8,'Z':9,
                      '0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9};
    const weights   = [8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
    function checkDigit(vin){
      let sum=0;
      for(let i=0;i<17;i++){ const c=vin[i]; const v=translit[c]; if(v===undefined) return null; sum += v*weights[i]; }
      const r = sum % 11; return r===10 ? 'X' : String(r);
    }
    function isValidVIN(vin){
      if(!vin || vin.length!==17) return false;
      if(/[IOQ]/.test(vin)) return false;
      return checkDigit(vin) === vin[8];
    }
    function normVIN(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,17); }
    const has17 = s => normVIN(s).length===17;

    // --- PWA install ---
    let deferredPrompt; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.hidden=false;});
    installBtn?.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.hidden=true;});

    // --- State ---
    const listEl=document.getElementById('list'), countEl=document.getElementById('count');
    const vins=new Map(); // vin -> record
    function load(){try{JSON.parse(localStorage.getItem('vins')||'[]').forEach(v=>vins.set(v.vin,v));}catch{}}
    function save(){localStorage.setItem('vins',JSON.stringify([...vins.values()]));}
    load();

    function render(){
      listEl.innerHTML='';
      const arr=[...vins.values()].sort((a,b)=>(b.ts||0)-(a.ts||0));
      countEl.textContent=String(arr.length);
      for(const v of arr){
        const cls=v.status==='OPEN'?'bad':v.status==='NONE'?'ok':'unk';
        const label=v.status==='OPEN'?'Recall: YES':v.status==='NONE'?'Recall: NO':'Unknown';
        const recallsHtml=(v.campaigns||[]).map(c=>`<div class="small recall">• ${c.id||''} — ${c.date||''} — ${c.component||''}</div>`).join('');
        const ymm=[v.year,v.make,v.model].filter(Boolean).join(' ');
        const verifyURL=`https://www.nhtsa.gov/recalls?vin=${encodeURIComponent(v.vin)}`;
        const oasisURL=`https://www.fordtechservice.dealerconnection.com/oasis/Index?vin=${encodeURIComponent(v.vin)}`;
        const row=document.createElement('div'); row.className='card';
        row.innerHTML=`
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div class="vin">${v.vin}</div>
              <div class="tag">${ymm||'—'}</div>
              <div class="small">${new Date(v.ts).toLocaleTimeString()}</div>
            </div>
            <div class="row right">
              <span class="pill ${cls}">${label}</span>
              <a class="pill" target="_blank" href="${verifyURL}">Verify (NHTSA)</a>
              <a class="pill" target="_blank" href="${oasisURL}">Open OASIS</a>
              <button class="pill" data-copy="${v.vin}">Copy VIN</button>
              <button class="pill" data-del="${v.vin}">Remove</button>
            </div>
          </div>
          <div>${recallsHtml || '<div class="small tag">No campaign details yet.</div>'}</div>`;
        listEl.appendChild(row);
      }
    }
    render();

    listEl.addEventListener('click',async(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      if(btn.dataset.copy){await navigator.clipboard.writeText(btn.dataset.copy);btn.textContent='Copied';setTimeout(()=>btn.textContent='Copy VIN',900);}
      if(btn.dataset.del){vins.delete(btn.dataset.del);save();render();}
    });

    // --- Feedback helpers ---
    const scanmsg = document.getElementById('scanmsg');
    const toast   = document.getElementById('toast');
    function setScanMsg(html, cls=''){ scanmsg.className='scanmsg '+cls; scanmsg.innerHTML=html; }
    let beep = null;
    try { beep = new Audio("data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICAgP//"); } catch {}

    function showToast(text, color=''){ toast.textContent=text; toast.style.borderColor = 'var(--line)'; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1200); }

    // --- VIN decode + recall check ---
    async function decodeYMM(v){
      try{
        const r=await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${encodeURIComponent(v)}?format=json`);
        const j=await r.json(); const row=j?.Results?.[0]||{};
        return {year:row.ModelYear||'', make:row.Make||'', model:row.Model||''};
      }catch{return {};}
    }
    async function checkVINRecall(v){
      try{
        const r=await fetch(`https://api.nhtsa.gov/recalls/recallsByVin?vin=${encodeURIComponent(v)}`);
        if(r.ok){
          const j=await r.json(); const items=j?.results||j?.Results||[];
          if(Array.isArray(items) && items.length){
            return {status:'OPEN', campaigns:items.map(x=>({id:x.NHTSACampaignNumber||x.campaignNumber||'', component:x.Component||x.ComponentDescription||'', date:x.ReportReceivedDate||x.reportReceivedDate||''}))};
          } else { return {status:'NONE', campaigns:[]}; }
        }
      }catch(e){}
      return {status:'UNKNOWN', campaigns:[]};
    }

    // --- Accept VIN with multi-check accuracy ---
    // 1) require 17 chars, exclude I/O/Q, valid ISO check digit
    // 2) require stability: same 17-char VIN detected in >=2 of last 4 frames
    // 3) cross-check: decode year/make/model (must return something); still accept if missing due to rare edge cases
    const recent = []; // sliding window of last 8 reads
    const counts = new Map(); // candidate -> hits in window
    const WINDOW = 4;
    let acceptCooldown = 0;

    function pushCandidate(vin){
      recent.push(vin);
      if(recent.length>8){ recent.shift(); }
      counts.clear();
      for(let i = Math.max(0,recent.length-WINDOW); i<recent.length; i++){
        const k = recent[i];
        counts.set(k, (counts.get(k)||0)+1);
      }
      let best = {vin:null, hits:0};
      counts.forEach((hits,k)=>{ if(hits>best.hits) best={vin:k,hits}; });
      return best;
    }

    async function considerCandidate(raw){
      const cand = normVIN(raw);
      if(!has17(cand)) { setScanMsg(`Reading… <span class="tag">${cand}</span>`, ''); return; }
      if(!isValidVIN(cand)) { setScanMsg(`Rejected (checksum): <span class="scanerr">${cand}</span>`, ''); return; }

      const best = pushCandidate(cand);
      setScanMsg(`Confirming… ${best.vin} <span class="tag">(${best.hits}/${WINDOW})</span>`, '');

      // require at least 2 hits in last WINDOW frames and cooldown elapsed
      if(best.vin===cand && best.hits>=2 && (Date.now()-acceptCooldown)>500){
        acceptCooldown = Date.now();
        await acceptVIN(cand);
      }
    }

    // Dedup total list, update if re-scanned
    async function acceptVIN(vin){
      if(beep) { try{ beep.currentTime=0; beep.play(); }catch{} }
      try{ navigator.vibrate && navigator.vibrate([40,30,40]); }catch{}

      setScanMsg(`Accepted: <span class="scanok">${vin}</span>`, 'scanok');
      showToast('VIN accepted ✅');

      if(!vins.has(vin)) vins.set(vin,{vin});
      const rec=vins.get(vin);
      rec.ts=Date.now(); rec.status='CHECKING'; rec.campaigns=[]; save(); render();

      Object.assign(rec, await decodeYMM(vin)); save(); render();
      const result = await checkVINRecall(vin);
      Object.assign(rec, result); save(); render();

      // Promote recalls visually by moving OPEN to top (keep stable sort)
      if(rec.status==='OPEN'){
        // simple reinsert to refresh order
        vins.delete(vin); vins.set(vin, rec);
        render();
      }
    }

    // Manual entry
    document.getElementById('manual').addEventListener('keydown',e=>{
      if(e.key==='Enter'){ const v=normVIN(e.target.value); e.target.value=''; if(isValidVIN(v)) acceptVIN(v); else showToast('Invalid VIN (checksum)', ''); }
    });

    // --- Camera (ZXing continuous) ---
    const startBtn=document.getElementById('start'), stopBtn=document.getElementById('stop'), video=document.getElementById('preview');
    let codeReader, controls;
    async function startCamera(){
      try{
        const ZXB=window.ZXingBrowser, ZX=window.ZXing;
        if(!ZXB||!ZX) throw new Error('Scanner not ready (lib)');
        codeReader=new ZXB.BrowserMultiFormatReader();
        const devices=await ZXB.BrowserCodeReader.listVideoInputDevices();
        const back=devices.find(d=>/back|rear|environment/i.test(d.label))?.deviceId;
        controls=await codeReader.decodeFromVideoDevice(back||undefined, video, (res)=>{
          if(res){
            const text=res.getText();
            // Extract best 17-char alphanumeric run and reject I/O/Q
            const candidate=(text.match(/[A-HJ-NPR-Z0-9]{17}/g)||[])[0]||text;
            considerCandidate(candidate);
          }
        }, {videoConstraints:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}}});
        setScanMsg('Camera started. Reading…','');
      }catch(e){
        setScanMsg('Camera error. Try Chrome/Edge on Android or allow camera permissions.','scanerr');
        alert("Camera start failed.\n"+(e?.message||e));
      }
    }
    function stopCamera(){ try{controls&&controls.stop(); codeReader&&codeReader.reset();}catch{} setScanMsg('Scanner stopped.',''); video.srcObject=null; }

    startBtn.addEventListener('click',startCamera);
    stopBtn.addEventListener('click',stopCamera);

    // Export & Clear
    document.getElementById('export').addEventListener('click',()=>{
      const rows=[['VIN','Year','Make','Model','Status','Campaigns']];
      for(const v of vins.values()){ rows.push([v.vin,v.year||'',v.make||'',v.model||'',v.status||'',(v.campaigns||[]).map(c=>c.id).join(' | ')]); }
      const blob=new Blob([rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n')],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='midway_recall_scan.csv'; a.click();
    });
    document.getElementById('clear').addEventListener('click',()=>{ if(confirm('Clear scanned list?')){ localStorage.removeItem('vins'); vins.clear(); render(); setScanMsg('List cleared.',''); } });
  </script>
</body>
</html>
